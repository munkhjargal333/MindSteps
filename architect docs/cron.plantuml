@startuml Analysis_Sequence_Weekly
!theme plain
title Шинжилгээний дарааллын диаграм - Долоо хоногийн гүн шинжилгээ

participant "CronJob" as Cron
participant "AIWeeklyService" as AWS
participant "DataAggregator" as DA
participant "AIModel" as Model
participant "RecommendationEngine" as RE
participant "Database" as DB
participant "NotificationService" as NS

Cron -> AWS: trigger weekly analysis
activate AWS

AWS -> DB: get active users
activate DB
DB --> AWS: user list
deactivate DB

loop For each user
    AWS -> DA: aggregateWeeklyData(userId)
    activate DA
    
    DA -> DB: get journals (7 days)
    DB --> DA: journals
    
    DA -> DB: get mood entries (7 days)
    DB --> DA: moods
    
    DA -> DB: get ai analyses
    DB --> DA: analyses
    
    DA -> DA: consolidateData()
    DA --> AWS: weekly data
    deactivate DA
    
    ' Deep AI analysis
    AWS -> Model: performDeepAnalysis(weeklyData)
    activate Model
    
    Model -> Model: identifyHiddenPatterns()
    Model -> Model: detectUnconsciousTriggers()
    Model -> Model: analyzeValueConflicts()
    Model -> Model: identifyEmotionalCycles()
    Model -> Model: detectUnmetNeeds()
    
    Model --> AWS: deep insights
    deactivate Model
    
    ' Generate recommendations
    AWS -> RE: generateRecommendations(insights)
    activate RE
    
    RE -> DB: get user core values
    DB --> RE: values
    
    RE -> DB: get available lessons
    DB --> RE: lessons
    
    RE -> RE: matchLessonsToNeeds()
    RE -> RE: prioritizeActions()
    
    RE --> AWS: recommendations
    deactivate RE
    
    ' Save analysis
    AWS -> DB: INSERT ai_weekly_deep_analysis
    activate DB
    DB --> AWS: analysisId
    deactivate DB
    
    ' Create insights
    AWS -> DB: INSERT user_insights
    DB --> AWS: success
    
    ' Send notification
    AWS -> NS: sendWeeklyInsightNotification(userId)
    activate NS
    NS --> AWS: sent
    deactivate NS
    
    AWS -> AWS: log completion
end

AWS --> Cron: analysis complete
deactivate AWS

@enduml