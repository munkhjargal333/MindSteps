@startuml Architecture_Modular_Monolith
!theme plain
title Системийн Архитектур - Modular Monolith + Event-Driven

skinparam componentStyle rectangle

' Client Layer
rectangle "Клиент" #LightBlue {
  [Next.js Web App]
}

' Single Application
rectangle "Monolith Application (Golang + Fiber)" #LightGreen {
  
  rectangle "API Layer" #WhiteSmoke {
    [REST API Handlers]
    [WebSocket Handler]
    [Middleware: Auth/CORS/Rate Limit]
  }
  
  rectangle "Domain Modules" #Wheat {
    [User Module]
    [Journal Module]
    [Mood Module]
    [Goal Module]
    [Meditation Module]
    [Lesson Module]
    [Gamification Module]
    [Analytics Module]
  }
  
  rectangle "Shared Kernel" #LightCyan {
    [Event Bus]
    [Repository Layer]
    [Domain Events]
  }
  
  rectangle "Background Jobs" #LavenderBlush {
    [AI Analysis Job]
    [Gamification Job]
    [Pattern Detection Job]
    [Notification Job]
    [Weekly Analysis Job]
  }
}

' Separate AI Service
rectangle "AI Service (Python FastAPI)" #Orange {
  [NLP Engine]
  [Pattern Detector]
  [Recommendation Engine]
}

' Infrastructure
rectangle "Infrastructure" #LightGray {
  database "PostgreSQL" as PG {
    [Main Database]
  }
  
  database "Redis" as Redis {
    [Cache]
    [Event Streams]
    [Session Store]
  }
  
  cloud "External Services" as Ext {
    [Hugging Face API]
    [SendGrid Email]
  }
}

' Connections
[Next.js Web App] -down-> [REST API Handlers] : HTTPS
[Next.js Web App] -down-> [WebSocket Handler] : WSS

[REST API Handlers] -down-> [User Module]
[REST API Handlers] -down-> [Journal Module]
[REST API Handlers] -down-> [Mood Module]
[REST API Handlers] -down-> [Goal Module]

[Journal Module] -down-> [Event Bus] : publish
[Mood Module] -down-> [Event Bus] : publish
[Goal Module] -down-> [Event Bus] : publish

[Event Bus] -right-> [Redis] : streams

[Event Bus] -down-> [AI Analysis Job] : consume
[Event Bus] -down-> [Gamification Job] : consume
[Event Bus] -down-> [Pattern Detection Job] : consume

[AI Analysis Job] -right-> [AI Service] : HTTP
[Pattern Detection Job] -right-> [AI Service] : HTTP

[AI Service] -down-> [Ext] : API call

[Repository Layer] -down-> [PG]
[User Module] -down-> [Redis] : cache
[Analytics Module] -down-> [Redis] : cache

[Notification Job] -down-> [Ext] : email

note right of [Event Bus]
  **Internal Event System**
  • In-memory first
  • Redis backup
  • Retry logic
  • Async processing
end note

note bottom of [Domain Modules]
  **Модульчлагдсан бүтэц**
  • Module бүр независимый
  • Shared kernel ашиглана
  • Event-аар холбогдоно
  • Microservice руу шилжих бэлэн
end note

@enduml